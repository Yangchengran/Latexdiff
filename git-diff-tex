#!/usr/bin/env python3

import argparse
import subprocess
import tempfile
import shutil
import os
import sys

def get_git_content(commit, filename, output_path):
    """
    ä» Git å†å²ä¸­æå–æ–‡ä»¶å†…å®¹å¹¶å†™å…¥ output_path
    """
    try:
        # git show commit:filename
        content = subprocess.check_output(
            ["git", "show", f"{commit}:{filename}"], 
            stderr=subprocess.PIPE
        )
        with open(output_path, "wb") as f:
            f.write(content)
        return True
    except subprocess.CalledProcessError:
        print(f"âŒ é”™è¯¯: åœ¨ç‰ˆæœ¬ {commit} ä¸­æ‰¾ä¸åˆ°æ–‡ä»¶ {filename}")
        return False

def main():
    parser = argparse.ArgumentParser(description="LaTeX å¤šæ¨¡å¼å¯¹æ¯”å·¥å…·")
    parser.add_argument("filename", help="æ–‡ä»¶å (ä¾‹å¦‚ main.tex)")
    
    # è¿™é‡Œæˆ‘ä»¬è¦çµæ´»å¤„ç†å‚æ•°
    parser.add_argument("old_commit", help="æ—§ç‰ˆæœ¬ Commit (ä¾‹å¦‚ HEAD~1)", nargs="?", default="HEAD~1")
    parser.add_argument("new_commit", help="æ–°ç‰ˆæœ¬ Commit (å¯é€‰ï¼Œä¸å¡«åˆ™å¯¹æ¯”å½“å‰ç¡¬ç›˜æ–‡ä»¶)", nargs="?")
    
    args = parser.parse_args()

    cwd = os.getcwd()
    output_pdf = "diff.pdf"

    # 1. åˆ›å»ºä¸´æ—¶æ²™ç›’
    with tempfile.TemporaryDirectory() as temp_dir:
        print(f"ğŸ”§ æ­£åœ¨å‡†å¤‡å¯¹æ¯”ç¯å¢ƒ...")

        # --- å‡†å¤‡æ—§æ–‡ä»¶ ---
        old_file_path = os.path.join(temp_dir, "old.tex")
        print(f"ğŸ“¥ æå–æ—§ç‰ˆæœ¬: {args.old_commit}")
        if not get_git_content(args.old_commit, args.filename, old_file_path):
            sys.exit(1)

        # --- å‡†å¤‡æ–°æ–‡ä»¶ ---
        new_file_path = ""
        
        if args.new_commit:
            # æ¨¡å¼ A: æŒ‡å®šäº†ä¸¤ä¸ª commit (Commit vs Commit)
            print(f"ğŸ“¥ æå–æ–°ç‰ˆæœ¬: {args.new_commit}")
            new_file_path = os.path.join(temp_dir, "new.tex")
            if not get_git_content(args.new_commit, args.filename, new_file_path):
                sys.exit(1)
        else:
            # æ¨¡å¼ B: åªæŒ‡å®šäº†ä¸€ä¸ª (Commit vs WorkTree)
            print(f"ğŸ“‚ ä½¿ç”¨å½“å‰å·¥ä½œåŒºæ–‡ä»¶ä½œä¸ºæ–°ç‰ˆæœ¬")
            new_file_path = os.path.join(cwd, args.filename)

        # 2. è¿è¡Œ latexdiff
        print("ğŸ“ æ­£åœ¨ç”Ÿæˆ Diff TeX...")
        diff_tex_path = os.path.join(temp_dir, "diff.tex")
        
        # è¿è¡Œ latexdiff
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åŠ ä¸Š --flatten ä»¥é˜²ä¸‡ä¸€ä½ æœ‰ inputï¼Œè™½ç„¶å•æ–‡ä»¶é€šå¸¸ä¸éœ€è¦
        cmd_diff = f"latexdiff {old_file_path} {new_file_path} > {diff_tex_path}"
        try:
            subprocess.run(cmd_diff, shell=True, check=True, stderr=subprocess.PIPE)
        except subprocess.CalledProcessError as e:
            print("âŒ latexdiff è¿è¡Œå¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶å·®å¼‚è¿‡å¤§æˆ–è¯­æ³•é—®é¢˜ã€‚")
            sys.exit(1)

        # 3. ç¼–è¯‘ PDF
        print("âš™ï¸  æ­£åœ¨ç¼–è¯‘ PDF...")
        
        # æ ¸å¿ƒæŠ€å·§ï¼šå³ä¾¿ä¸¤ä¸ªæ–‡ä»¶éƒ½åœ¨ temp ç›®å½•ï¼Œæˆ‘ä»¬ä¾ç„¶è¦æŠŠ TEXINPUTS æŒ‡å‘ cwd
        # è¿™æ ·ä¸¤ä¸ªå†å²ç‰ˆæœ¬é‡Œçš„å›¾ç‰‡å¼•ç”¨éƒ½èƒ½æ‰¾åˆ°
        env = os.environ.copy()
        env['TEXINPUTS'] = f".:{cwd}:" 

        compile_cmd = ["pdflatex", "-interaction=nonstopmode", "diff.tex"]
        
        try:
            # è·‘ä¸¤æ¬¡ä»¥ä¿®æ­£å¼•ç”¨
            subprocess.run(compile_cmd, cwd=temp_dir, env=env, stdout=subprocess.DEVNULL)
            subprocess.run(compile_cmd, cwd=temp_dir, env=env, stdout=subprocess.DEVNULL)
        except Exception:
            print("âŒ ç¼–è¯‘å¤±è´¥")
            sys.exit(1)

        # 4. å–å›ç»“æœ
        generated_pdf = os.path.join(temp_dir, "diff.pdf")
        if os.path.exists(generated_pdf):
            shutil.move(generated_pdf, os.path.join(cwd, output_pdf))
            print(f"âœ… æˆåŠŸï¼Diff æ–‡ä»¶å·²ç”Ÿæˆ: {output_pdf}")
            if args.new_commit:
                print(f"   (å¯¹æ¯”èŒƒå›´: {args.old_commit} <--> {args.new_commit})")
            else:
                print(f"   (å¯¹æ¯”èŒƒå›´: {args.old_commit} <--> å½“å‰ç¡¬ç›˜æ–‡ä»¶)")
        else:
            print("âŒ æœªç”Ÿæˆ PDFã€‚")

if __name__ == "__main__":
    main()